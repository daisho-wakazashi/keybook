<%
  # Required locals:
  # - day: Date object for this cell
  # - hour: Integer hour (0-23)
  # - selectable: Boolean, whether cells can be selected
  # - availabilities: Array of availability objects

  # Use local timezone (Time.zone) instead of UTC
  cell_datetime = Time.zone.local(day.year, day.month, day.day, hour, 0, 0)
  cell_id = "cell-#{day.to_s}-#{hour}"

  # Check if this cell has an availability and if it's booked
  availability_for_cell = availabilities.find do |avail|
    avail_start = avail.start_time.in_time_zone(Time.zone)
    avail_end = avail.end_time.in_time_zone(Time.zone)
    avail_start <= cell_datetime && avail_end > cell_datetime
  end

  has_availability = availability_for_cell.present?
  is_booked = has_availability && availability_for_cell.booking.present?
  booker_name = is_booked ? availability_for_cell.booking.booker.full_name : nil

  css_classes = ["week-calendar-hour-cell"]
  css_classes << "week-calendar-hour-cell-selectable" if selectable && !is_booked
  css_classes << "week-calendar-hour-cell-availability" if has_availability && !is_booked
  css_classes << "week-calendar-hour-cell-booked" if is_booked
%>

<div
  id="<%= cell_id %>"
  class="<%= css_classes.join(' ') %>"
  <% if selectable && !is_booked %>
    data-calendar-selection-target="cell"
    data-date="<%= day.to_s %>"
    data-hour="<%= hour %>"
    data-datetime="<%= cell_datetime.iso8601 %>"
    data-action="mousedown->calendar-selection#startSelection mouseover->calendar-selection#updateSelection"
  <% end %>
>
  <% if is_booked %>
    <span class="week-calendar-booker-name"><%= booker_name %></span>
  <% end %>
</div>
